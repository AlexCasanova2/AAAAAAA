import{r as l,z as G,c as K,a as d,k as u,b as r,w as W,q as T,F as H,m as $,v as Y,x as m,n as S,s as v,u as J,o as i,t as A,e as D}from"./index-DGUlPAX8.js";import{A as P}from"./AppHeader-B-6ciBPX.js";import{M as Q,A as X,F as Z,U as ee}from"./AudioPlayer-DpyHLoYy.js";import{C as te}from"./ConfirmModal-sEQj-RFe.js";import{c as U,A as oe}from"./arrow-left-7li7JSlN.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";/**
 * @license lucide-vue-next v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ae=U("Loader2Icon",[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]]);/**
 * @license lucide-vue-next v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const re=U("Trash2Icon",[["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6",key:"4alrt4"}],["path",{d:"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2",key:"v07s0e"}],["line",{x1:"10",x2:"10",y1:"11",y2:"17",key:"1uufr5"}],["line",{x1:"14",x2:"14",y1:"11",y2:"17",key:"xtxkd"}]]),se={class:"h-[100dvh] bg-[var(--color-dark-background)] text-white flex flex-col"},ne={class:"flex-1 p-4",style:{paddingTop:"calc(4rem + env(safe-area-inset-top))"}},ie={key:0,class:"flex justify-center items-center h-full"},le={key:1,class:"flex justify-center items-center h-full"},ce={key:2,class:"space-y-4"},de={class:"font-medium text-lg mb-3"},ue={class:"space-y-3"},he={class:"flex justify-between items-start mb-2"},fe={class:"font-semibold text-xl"},me={class:"text-gray-300 text-sm"},pe=["onClick","disabled"],ve={class:"p-1 flex items-center justify-center hover:opacity-80 transition-opacity","aria-label":"Historial"},ge={class:"flex-1 flex justify-center items-center",style:{paddingTop:"calc(4rem + env(safe-area-inset-top))"}},ye={class:"bg-[var(--color-dark-background)] text-white rounded-full w-20 h-20 flex items-center justify-center hover:bg-[#333] transition-colors duration-200 shadow-sm","aria-label":"Gravar"},be="gritos",Ae={__name:"HistoryView",setup(we){const C=J(),w=l(null),x=l(!1),_=l({x:0,y:0}),j=l(24),k=l([]),M=l(!0),g=l(null),y=l(!1),f=l(null),E=async()=>{M.value=!0;try{const{data:t,error:o}=await v.from("gritos").select("id, audio_url, created_at, name").order("created_at",{ascending:!1});if(o)throw o;const s=t.reduce((a,e)=>{const n=new Date(e.created_at),h=n.getFullYear(),c=n.getMonth(),p=`${h}-${c}`;a[p]||(a[p]={month:z(n),recordings:[]});let b;if(e.audio_url.startsWith("data:"))b=e.audio_url;else{const R=e.audio_url.replace(/^https?:\/\/[^\/]+\/storage\/v1\/object\/public\/gritos\//,""),{data:I}=v.storage.from("gritos").getPublicUrl(R);b=I.publicUrl}return console.log("URL de audio procesada:",{original:e.audio_url,processed:b,path:e.audio_url.replace(/^https?:\/\/[^\/]+\/storage\/v1\/object\/public\/gritos\//,"")}),a[p].recordings.push({id:e.id,title:e.name,createdAt:e.created_at,filePath:b}),a},{});k.value=Object.keys(s).sort((a,e)=>new Date(e)-new Date(a)).map(a=>s[a])}catch(t){console.error("Error cargando grabaciones:",t.message)}finally{M.value=!1}},B=t=>{const o=new Date(t),a=new Date-o,e=Math.floor(a/6e4),n=Math.floor(e/60),h=Math.floor(n/24);return h>0?`Hace ${h} días`:n>0?`Hace ${n} horas`:e>0?`Hace ${e} minutos`:"Ahora mismo"},z=t=>{const o={year:"numeric",month:"long"};return t.toLocaleDateString("es-ES",o)};G(()=>{E()});const V=K(()=>{const t=_.value.x,o=_.value.y,s=j.value;return{viewTransitionName:"circular-reveal","--circle-x":`${t}px`,"--circle-y":`${o}px`,"--circle-size":`${s}px`,"--circle-color":"#fefefe"}}),F=()=>{if(!w.value)return;const t=w.value.getBoundingClientRect();_.value={x:t.left+t.width/2,y:t.top+t.height/2},x.value=!0,setTimeout(()=>{C.push("/")},800);const o=performance.now(),s=1200,a=Math.max(window.innerWidth,window.innerHeight)*4,e=n=>{const h=n-o,c=Math.min(h/s,1),p=c<.5?4*c*c*c:1-Math.pow(-2*c+2,3)/2;j.value=24+(a-24)*p,c<1?requestAnimationFrame(e):x.value=!1};requestAnimationFrame(e)},L=()=>{C.push("/profile")},N=t=>{f.value=t,y.value=!0},O=async t=>{if(f.value)try{g.value=!0;const{error:o}=await v.from("deletion_logs").insert({recording_id:f.value.id,reason_selected:t.selected,other_reason:t.otherText||null,created_at:new Date().toISOString()});if(o)throw o;const s=f.value.filePath.replace(/^https?:\/\/[^\/]+\/storage\/v1\/object\/public\/gritos\//,""),{error:a}=await v.storage.from(be).remove([s]);if(a)throw a;const{error:e}=await v.from("gritos").delete().eq("id",f.value.id);if(e)throw e;await E()}catch(o){console.error("Error al eliminar y registrar el motivo en Supabase:",o.message)}finally{g.value=!1,y.value=!1,f.value=null}},q=t=>{console.log("Motivo de eliminación (Supabase):",t.selected),t.selected==="Otros"&&t.otherText&&console.log("Detalle del motivo (Supabase - Otros):",t.otherText),O(t)};return(t,o)=>(i(),d("div",se,[u(P,{title:"Historial","dark-mode":!0},{"right-content":T(()=>[r("button",{class:"p-1 flex items-center justify-center hover:opacity-80 transition-opacity","aria-label":"Tornar",onClick:F,ref_key:"backButton",ref:w},[u(m(oe),{class:"w-6 h-6 stroke-white"})],512)]),_:1}),r("div",ne,[M.value?(i(),d("div",ie,o[1]||(o[1]=[r("div",{class:"animate-spin rounded-full h-8 w-8 border-b-2 border-white"},null,-1)]))):k.value.length===0?(i(),d("div",le,o[2]||(o[2]=[r("p",{class:"text-white/70"},"No hay grabaciones",-1)]))):(i(),d("div",ce,[(i(!0),d(H,null,$(k.value,(s,a)=>(i(),d("div",{key:s.month,class:"rounded-lg p-4",style:S({"animation-delay":`${a*50}ms`})},[r("h3",de,A(s.month),1),r("div",ue,[(i(!0),d(H,null,$(s.recordings,(e,n)=>(i(),d("div",{key:e.id,class:"bg-gradient-to-br from-gray-800 to-gray-900 rounded-lg p-5 transition-all duration-300 ease-in-out shadow-lg border border-white/10 animate-fade-in-up hover:scale-[1.01] hover:shadow-xl",style:S({"animation-delay":`${n*50}ms`})},[r("div",he,[r("div",null,[r("h4",fe,A(e.title),1),r("p",me,A(B(e.createdAt)),1)]),r("button",{onClick:h=>N(e),class:"p-2 hover:bg-white/20 rounded-full transition-colors duration-200",disabled:g.value===e.id},[g.value!==e.id?(i(),D(m(re),{key:0,class:"w-5 h-5 stroke-white/70 hover:stroke-white"})):(i(),D(m(ae),{key:1,class:"w-5 h-5 stroke-white animate-spin"}))],8,pe)]),u(X,{src:e.filePath,class:"w-full"},null,8,["src"])],4))),128))])],4))),128))]))]),W(r("div",{class:"fixed inset-0 z-40 flex flex-col bg-[var(--color-dark-background)] text-[var(--color-dark-background)] view-transition",style:S(V.value)},[u(P,{title:"","dark-mode":!1},{"left-content":T(()=>[r("button",{class:"p-1 flex items-center justify-center hover:opacity-80 transition-opacity","aria-label":"Perfil",onClick:L},[u(m(ee),{class:"w-6 h-6 stroke-[var(--color-dark-background)]"})])]),"right-content":T(()=>[r("button",ve,[u(m(Z),{class:"w-6 h-6 stroke-[var(--color-dark-background)]"})])]),_:1}),r("div",ge,[r("button",ye,[u(m(Q),{class:"w-7 h-7 stroke-white"})])])],4),[[Y,x.value]]),u(te,{modelValue:y.value,"onUpdate:modelValue":o[0]||(o[0]=s=>y.value=s),title:"Aviso, estás a punto de borrar tu ¡Grito!, ¿estás seguro?",message:"Esta acción no se puede deshacer.","confirm-text":"Sí, estoy seguro","cancel-text":"Cambié de opinión","reasons-title":"¿Por qué quieres borrar tu Grito?",reasons:[{value:"No me gusta mi grito",label:"No me gusta mi grito"},{value:"Ha habido un error en la grabacion",label:"Ha habido un error en la grabación"},{value:"Contenido inapropiado",label:"Contenido inapropiado"},{value:"Otros",label:"Otros"}],onConfirm:q},null,8,["modelValue"])]))}};export{Ae as default};
